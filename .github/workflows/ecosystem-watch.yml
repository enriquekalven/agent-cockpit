name: ğŸ“¡ Agent Ecosystem Watcher

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  watch-ecosystem:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install rich packaging feedparser
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ğŸ” Run Ecosystem Watch
        id: watch
        continue-on-error: true
        run: |
          # We use a temp file to capture the output for the issue body
          python src/agent_ops_cockpit/ops/watcher.py > watch_output.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          cat watch_output.txt
          
          # If exit code is 2, it means updates were found
          if [ $EXIT_CODE -eq 2 ]; then
            echo "updates_found=true" >> $GITHUB_OUTPUT
          else
            echo "updates_found=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ« Create Issue for Updates
        if: steps.watch.outputs.updates_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('watch_output.txt', 'utf8');
            const date = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ AgentOps: Ecosystem Upgrade Required (${date})`,
              body: "### ğŸ” AgentOps Cockpit detected new SDK/Protocol updates.\n\n```text\n" + output + "\n```\n\n**Protocol & Engine Safety Check**: Please verify these updates against the Agent Trinity before applying.",
              labels: ['enhancement', 'dependencies']
            });
