FROM python:3.11-slim

WORKDIR /app

# Install dependencies separately for caching
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir fastapi uvicorn pydantic vertexai google-cloud-aiplatform google-cloud-logging google-cloud-trace

# Copy the source code
COPY src/ ./src/

# Set the working directory to the parent of the package
WORKDIR /app/src

# Set PYTHONPATH to include the current directory
ENV PYTHONPATH=/app/src

# Run with uvicorn, ensuring we listen on the port Cloud Run expects
CMD ["sh", "-c", "uvicorn agent_ops_cockpit.agent:app --host 0.0.0.0 --port ${PORT:-8080}"]
